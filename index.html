<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulateur marge V11 â€“ PAC & Ballons</title>
<style>
  html,body{margin:0;padding:0;background:#fafafa;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial,sans-serif;color:#111}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px;}
  h1{font-size:22px;margin:0 0 12px;}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
  select,button{font-size:16px;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px;background:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card h2{font-size:15px;margin:0;padding:12px 14px;border-bottom:1px solid #eef2f7;background:#fafbfc;border-radius:14px 14px 0 0}
  .body{padding:12px 14px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eef2f7;padding:9px 8px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  tfoot td{font-weight:700}
  input[type="number"]{width:100%;max-width:180px;padding:8px 9px;border:1px solid #d0d5dd;border-radius:8px;text-align:right}
  .marge-card{margin:6px 0 16px;padding:16px;border-radius:16px;border:1px solid #e5e7eb;background:#ffffff;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .marge-card.ok{background:#dcfce7;border-color:#22c55e;box-shadow:0 2px 8px rgba(34,197,94,.15)}
  .marge-card.mid{background:#ffedd5;border-color:#f97316;box-shadow:0 2px 8px rgba(249,115,22,.15)}
  .marge-card.warn{background:#fef3c7;border-color:#f59e0b;box-shadow:0 2px 8px rgba(245,158,11,.15)}
  .marge-card.bad{background:#fee2e2;border-color:#ef4444;box-shadow:0 2px 8px rgba(239,68,68,.15)}
  .mc-top{display:flex;align-items:center;gap:8px;font-weight:700}
  .mc-value{font-size:34px;font-weight:800;margin-top:6px}
  .muted{color:#667085;font-size:12px}
  .kv{display:flex;justify-content:space-between;gap:12px;margin-top:8px}
  .kv div{flex:1;background:#fff;border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px}
  .kv b{display:block;font-size:12px;color:#475467;margin-bottom:4px}
  .kv span{font-weight:700}
  @media(max-width:900px){
    .grid{grid-template-columns:1fr}
    select,button{min-height:44px}
    input[type="number"]{max-width:100%}
  }
  .kv input[type="number"]{width:100%;max-width:100%;padding:8px 9px;border:1px solid #d0d5dd;border-radius:8px;text-align:right}
  .hidden{display:none!important}
  .kv{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
  .kv div{flex:0 1 160px;max-width:180px;background:#fff;border:1px dashed #e5e7eb;border-radius:10px;padding:6px 8px;text-align:center}
  .kv b{display:block;font-size:12px;color:#475467;margin-bottom:4px}
  .kv span{font-weight:700}
  .kv input[type="number"]{width:100%;max-width:90px;margin:0 auto;height:36px;padding:4px 6px;border:1px solid #d0d5dd;border-radius:8px;text-align:center}

/* === Two-column centered tiles === */
.marge-card .kv{
  display:grid;
  grid-template-columns:repeat(2,minmax(220px,1fr));
  gap:14px;
  max-width:560px;
  margin:12px auto 0; /* center */
}
.marge-card .kv div{
  background:#fff;
  border:1px dashed #e5e7eb;
  border-radius:14px;
  padding:12px 14px;
  text-align:center;
}
.marge-card .kv b{
  display:block;
  font-size:13px;
  color:#475467;
  margin-bottom:6px;
}
.marge-card .kv span{
  font-weight:800;
  font-size:18px;
}
.marge-card .kv input[type="number"]{
  width:100%;
  max-width:120px;
  margin:0 auto;
  height:44px;
  padding:6px 10px;
  border:1px solid #cbd5e1;
  border-radius:10px;
  text-align:center;
  font-size:16px;
}
@media (max-width:480px){
  .marge-card .kv{grid-template-columns:repeat(2,minmax(150px,1fr));gap:10px;max-width:100%}
  .marge-card .kv input[type="number"]{max-width:100px;height:40px}
}


/* ==== Mobile polish for the top controls ==== */
@media (max-width: 720px){
  .bar{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
    align-items:stretch;
    margin-bottom:16px;
  }
  .bar label{
    font-size:14px;
    color:#334155;
    margin:2px 4px 0;
  }
  .bar select, .bar button{
    width:100%;
    min-height:48px;
    font-size:16px;
    border-radius:12px;
  }
  #reset{ font-weight:600 }
}


/* === Improved 2-column layout for top controls === */
@media (max-width: 720px){
  .bar{
    display:grid !important;
    grid-template-columns:1fr 1fr !important;
    gap:12px;
    margin-bottom:18px;
  }
  .bar > div, .bar > label{
    width:100%;
  }
  .bar select, .bar button{
    width:100%;
    min-height:48px;
    font-size:15px;
    border-radius:12px;
  }
  #reset{
    grid-column:1 / span 2; /* Full width */
    font-weight:600;
  }
}


/* === Prominent centered status text === */
.marge-card .mc-value{
  text-align:center !important;
  font-size:46px !important;
  line-height:1.1;
  font-weight:900 !important;
  letter-spacing:0.2px;
}
.marge-card.ok .mc-value{ color:#065F46 !important; }   /* deep green */
.marge-card.mid .mc-value{ color:#B45309 !important; }  /* deep orange */
.marge-card.bad .mc-value{ color:#B91C1C !important; }  /* deep red */

</style>
</head>
<body>
<div class="wrap">
  <h1>Simulateur PAC & Ballons</h1>
  <div class="bar">
    <label for="foyer"><strong>MÃ©nage :</strong></label>
    <select id="foyer">
      <option value="BLEU" selected>Bleu</option>
      <option value="JAUNE">Jaune</option>
      <option value="VIOLET">Violet</option>
      <option value="ROSE">Rose</option>
    </select>
    <label for="scenario"><strong>ScÃ©nario :</strong></label>
    <select id="scenario">
      <option value="PAC" selected>PAC</option>
      <option value="PAC_ELEC">PAC + Ballon Ã©lectrique</option>
      <option value="PAC_THERMO">PAC + Ballon thermo</option>
      <option value="PAC_SSC">PAC + Ballon SSC</option>
    </select>

    <!-- Nouveaux sÃ©lecteurs sur la mÃªme ligne -->
    <label for="zone"><strong>Zone :</strong></label>
    <select id="zone">
      <option value="H1" selected>H1</option>
      <option value="H2">H2</option>
      <option value="H3">H3</option>
    </select>

    <label for="surface"><strong>Superficie :</strong></label>
    <select id="surface">
      <option value="S70-">S &lt; 70 mÂ²</option>
      <option value="S70-90">70 â‰¤ S &lt; 90 mÂ²</option>
      <option value="S90-110">90 â‰¤ S &lt; 110 mÂ²</option>
      <option value="S110-130">110 â‰¤ S &lt; 130 mÂ²</option>
      <option value="S130+" selected>S â‰¥ 130 mÂ²</option>
    </select>

    <label for="etas"><strong>ETAS :</strong></label>
    <select id="etas">
      <option value="111-140">111% â‰¤ ETAS &lt; 140%</option>
      <option value="140-170" selected>140% â‰¤ ETAS &lt; 170%</option>
      <option value="170-200">170% â‰¤ ETAS &lt; 200%</option>
      <option value="200+">ETAS â‰¥ 200%</option>
    </select>

    <button id="reset">RÃ©initialiser</button>
  </div>

  <div id="margeCard" class="marge-card">
    <div class="mc-top">ðŸ“‹ Statut du dossier</div>
    <div id="margeMain" class="mc-value">0,00 â‚¬</div>
    <div id="margeNote" class="muted">PrÃ©rempli selon ton barÃ¨me + valeurs Excel.</div>
    <div class="kv">
      <div class="hidden"><b>Prix de vente HT</b><span id="pvht_box">0,00</span></div>
      <div><b>Prix de vente TTC</b><span id="pvttc_box">0,00</span></div>
      <div class="hidden"><b>CoÃ»t total HT</b><span id="cout_box">0,00</span></div>
      <div><b>MPR</b><span id="mpr_box">0,00</span></div>
      <div><b>CEE</b><span id="cee_box">0,00</span></div>
      <div><b>Prise en charge RAC (%)</b><input type="number" id="rac_pct_top" min="0" max="100" step="1" value="0"></div>
      <div><b>RAC TTC (aprÃ¨s geste)</b><span id="rac_box">0,00</span></div>
      <div><b>Prise en charge RAC</b><span id="rac_offert_box">0,00</span></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>ðŸŽ¯ Aides & paiement</h2>
      <div class="body">
        <table>
          <tbody>
            <tr><td>MPR (auto)</td><td><input type="number" id="mpr" min="0" step="0.01" inputmode="decimal"></td></tr>
            <tr><td>CEE</td><td><input type="number" id="cee" min="0" step="0.01" inputmode="decimal" value="0"></td></tr>
            <tr><td>Prix de vente TTC</td><td><input type="number" id="pvttc_input" min="0" step="0.01" inputmode="decimal"></td></tr>
            <tr><td>Prise en charge du RAC (%)</td><td><input type="number" id="rac_pct" min="0" max="100" step="1" value="0"></td></tr>
          </tbody>
        </table>
        <div class="muted">RAC TTC = PV TTC â€“ (MPR + CEE). PV HT = PV TTC Ã· 1,055.</div>
      </div>
    </div>

    <div class="card">
      <h2>ðŸ§¾ DÃ©tail des coÃ»ts (HT)</h2>
      <div class="body">
        <table>
          <thead><tr><th>Poste</th><th>Montant HT (â‚¬)</th></tr></thead>
          <tbody>
            <tr><td>MatÃ©riel</td><td><input type="number" id="mat" min="0" step="0.01" inputmode="decimal"></td></tr>
            <tr><td>Pose</td><td><input type="number" id="pose" min="0" step="0.01" inputmode="decimal"></td></tr>
            <tr><td>Accessoires</td><td><input type="number" id="acc" min="0" step="0.01" inputmode="decimal"></td></tr>
            <tr><td>Administration</td><td><input type="number" id="adm" min="0" step="0.01" inputmode="decimal"></td></tr>
          </tbody>
          <tfoot><tr><td>Total coÃ»t HT</td><td id="coutTotal">0,00</td></tr></tfoot>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>ðŸ’¶ RÃ©sultat</h2>
      <div class="body">
        <table>
          <tbody>
            <tr><td>Prix de vente HT</td><td id="pvht">0,00</td></tr>
            <tr><td>Prix de vente TTC</td><td id="pvttc">0,00</td></tr>
            <tr><td>RAC TTC (aprÃ¨s geste)</td><td id="rac">0,00</td></tr>
            <tr><td>MARGE HT (avant geste)</td><td id="marge_ht_brut">0,00 â‚¬</td></tr>
            <tr><td style="font-weight:700">MARGE HT aprÃ¨s geste</td><td style="font-weight:700" id="marge_ht">0,00 â‚¬</td></tr>
          </tbody>
        </table>
        <div class="muted" style="margin-top:6px">Marge HT = Prix de vente HT âˆ’ CoÃ»t total HT</div>
      </div>
    </div>
  </div>
</div>

<script>
const BASE_COST = {
  PAC:        { mat:2900, pose:2500, acc:500, adm:300 },
  ELEC:       { mat:200,  pose:0,    acc:0,   adm:0   },
  THERMO:     { mat:1100, pose:0,    acc:0,   adm:0   },
  SSC:        { mat:3200, pose:2300, acc:0,   adm:0   }
};
const BASE_PV = {
  PAC:        { ht:10322.27, ttc:10890 },
  ELEC:       { ht:2710.90, ttc:2860 },
  THERMO:     { ht:2710.90, ttc:2860 },
  SSC:        { ht:14180.09, ttc:14960 }
};
const MPR = {
  PAC:{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},
  ELEC:{BLEU:0,JAUNE:0,VIOLET:0,ROSE:0},
  THERMO:{BLEU:1200,JAUNE:800,VIOLET:400,ROSE:0},
  SSC:{BLEU:10000,JAUNE:8000,VIOLET:4000,ROSE:0}
};

const els = {
  foyer: document.getElementById('foyer'),
  scenario: document.getElementById('scenario'),
  zone: document.getElementById('zone'),
  surface: document.getElementById('surface'),
  etas: document.getElementById('etas'),
  reset: document.getElementById('reset'),
  mpr: document.getElementById('mpr'),
  cee: document.getElementById('cee'),
  pvttc_input: document.getElementById('pvttc_input'),
  mat: document.getElementById('mat'),
  pose: document.getElementById('pose'),
  acc: document.getElementById('acc'),
  adm: document.getElementById('adm'),
  coutTotal: document.getElementById('coutTotal'),
  pvht: document.getElementById('pvht'),
  pvttc: document.getElementById('pvttc'),
  rac: document.getElementById('rac'),
  pvht_box: document.getElementById('pvht_box'),
  pvttc_box: document.getElementById('pvttc_box'),
  cout_box: document.getElementById('cout_box'),
  rac_box: document.getElementById('rac_box'),
  rac_offert_box: document.getElementById('rac_offert_box'),
  mpr_box: document.getElementById('mpr_box'),
  cee_box: document.getElementById('cee_box'),
  rac_pct: document.getElementById('rac_pct'),
  marge_ht_brut: document.getElementById('marge_ht_brut'),
  marge_ht: document.getElementById('marge_ht'),
  margeMain: document.getElementById('margeMain'),
  margeCard: document.getElementById('margeCard'),
  margeNote: document.getElementById('margeNote'),
  rac_pct_top: document.getElementById('rac_pct_top')
};

function fmt(n){return (isNaN(n)?0:n).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});}
function toNum(v){const n=parseFloat(String(v).replace(',','.'));return isNaN(n)?0:n;}
function setNum(el,n){try{el.valueAsNumber=Number(n);}catch{} el.value=String(n); el.dispatchEvent(new Event('input',{bubbles:true}));}

function combineCost(key){
  let c = {...BASE_COST.PAC};
  if(key==='PAC_ELEC'){ c.mat+=BASE_COST.ELEC.mat; c.pose+=BASE_COST.ELEC.pose; c.acc+=BASE_COST.ELEC.acc; c.adm+=BASE_COST.ELEC.adm; }
  if(key==='PAC_THERMO'){ c.mat+=BASE_COST.THERMO.mat; c.pose+=BASE_COST.THERMO.pose; c.acc+=BASE_COST.THERMO.acc; c.adm+=BASE_COST.THERMO.adm; }
  if(key==='PAC_SSC'){ c.mat+=BASE_COST.SSC.mat; c.pose+=BASE_COST.SSC.pose; c.acc+=BASE_COST.SSC.acc; c.adm+=BASE_COST.SSC.adm; }
  return c;
}
function combinePV(key){
  let pv = { ht: BASE_PV.PAC.ht, ttc: BASE_PV.PAC.ttc };
  if(key==='PAC_ELEC'){ pv.ht += BASE_PV.ELEC.ht; pv.ttc += BASE_PV.ELEC.ttc; }
  if(key==='PAC_THERMO'){ pv.ht += BASE_PV.THERMO.ht; pv.ttc += BASE_PV.THERMO.ttc; }
  if(key==='PAC_SSC'){ pv.ht += BASE_PV.SSC.ht; pv.ttc += BASE_PV.SSC.ttc; }
  return pv;
}
function autoMPR(foyer,key){
  let total = MPR.PAC[foyer] || 0;
  if(key==='PAC_ELEC') total += MPR.ELEC[foyer] || 0;
  if(key==='PAC_THERMO') total += MPR.THERMO[foyer] || 0;
  if(key==='PAC_SSC') total += MPR.SSC[foyer] || 0;
  return total;
}
function paintCard(m){
  const c=els.margeCard; c.classList.remove('ok','mid','warn','bad');
  if(m >= 4000){
    c.classList.add('ok');
    els.margeNote.textContent='Excellente marge';
  } else if(m >= 2500){
    c.classList.add('mid');
    els.margeNote.textContent='Marge correcte';
  } else {
    c.classList.add('bad');
    els.margeNote.textContent='Marge faible';
  }
}




function recalc(){
  const mat=toNum(els.mat.value), pose=toNum(els.pose.value), acc=toNum(els.acc.value), adm=toNum(els.adm.value);
  const cout = mat+pose+acc+adm; els.coutTotal.textContent = fmt(cout); els.cout_box.textContent = fmt(cout);

  const mpr = toNum(els.mpr.value), cee = toNum(els.cee.value), pvttc_in = toNum(els.pvttc_input.value);
  const pvht = pvttc_in / 1.055;
  const rac_initial = pvttc_in - (mpr + cee);

  // percentage: prefer top input if present
  let pct = 0;
  if (els.rac_pct_top) pct = toNum(els.rac_pct_top.value);
  if (!els.rac_pct_top && els.rac_pct) pct = toNum(els.rac_pct.value);
  if (els.rac_pct && els.rac_pct_top && String(els.rac_pct.value) !== String(pct)) els.rac_pct.value = pct;
  pct = Math.min(100, Math.max(0, pct));

  const rac_offert_ttc = rac_initial * (pct/100);
  const rac_apres = rac_initial - rac_offert_ttc;
  const rac_offert_ht = rac_offert_ttc / 1.055;

  // Top card boxes
  els.pvttc.textContent = fmt(pvttc_in); els.pvttc_box.textContent = fmt(pvttc_in);
  els.pvht.textContent = fmt(pvht); els.pvht_box.textContent = fmt(pvht);
  els.rac.textContent = fmt(rac_apres); els.rac_box.textContent = fmt(rac_apres);
  if(els.rac_offert_box) els.rac_offert_box.textContent = fmt(rac_offert_ttc);
  if(els.mpr_box) els.mpr_box.textContent = fmt(mpr);
  if(els.cee_box) els.cee_box.textContent = fmt(cee);

  const marge_brut = pvht - cout; // avant geste
  const marge_apres = pvht - rac_offert_ht - cout; // on dÃ©duit la prise en charge (HT)

  if(els.marge_ht_brut) els.marge_ht_brut.textContent = fmt(marge_brut) + ' â‚¬';
  els.marge_ht.textContent = fmt(marge_apres) + ' â‚¬';
  /* Replace big number by status text */
if(marge_apres >= 4000){ els.margeMain.textContent='DOSSIER OK'; }
else if(marge_apres >= 2500){ els.margeMain.textContent='DOSSIER A AMÃ‰LIORER'; }
else { els.margeMain.textContent='DOSSIER REFUSÃ‰'; }

  paintCard(marge_apres);
}



function loadDefaults(){
  const key = els.scenario.value;
  const costs = combineCost(key);
  setNum(els.mat, costs.mat); setNum(els.pose, costs.pose); setNum(els.acc, costs.acc); setNum(els.adm, costs.adm);
  const pv = combinePV(key);
  setNum(els.pvttc_input, pv.ttc);
  setNum(els.mpr, autoMPR(els.foyer.value, key));
  setNum(els.cee, 0);
  if(els.rac_pct) setNum(els.rac_pct, 0);
  if(els.rac_pct_top) setNum(els.rac_pct_top, 0);
  recalc();
}
['foyer','scenario'].forEach(id=> document.getElementById(id).addEventListener('change', loadDefaults));
['mpr','cee','pvttc_input','mat','pose','acc','adm','rac_pct'].forEach(id=> document.getElementById(id)?.addEventListener('input', recalc));
if(document.getElementById('rac_pct_top')) document.getElementById('rac_pct_top').addEventListener('input', recalc);

// Nouveaux Ã©couteurs pour les filtres Zone / Surface / ETAS (prÃªts Ã  Ãªtre branchÃ©s aux barÃ¨mes)
['zone','surface','etas'].forEach(id =>
  document.getElementById(id).addEventListener('change', recalc)
);

document.getElementById('reset').addEventListener('click', loadDefaults);
document.addEventListener('DOMContentLoaded', loadDefaults);
</script>

<div id="cee_details" class="hidden" style="border:1px solid #e5e7eb;border-radius:16px;padding:14px 16px;margin:14px 0;background:#f8fafc">
  <h3>ðŸ“Š DÃ©tails CEE</h3>
  <div class="row"><span class="label">Zone</span> <span class="value" id="d_zone">â€”</span></div>
  <div class="row"><span class="label">Superficie</span> <span class="value" id="d_surface">â€”</span></div>
  <div class="row"><span class="label">ETAS</span> <span class="value" id="d_etas">â€”</span></div>
  <div class="row"><span class="label">ScÃ©nario</span> <span class="value" id="d_scenario">â€”</span></div>
  <div class="row"><span class="label">kWh CUMAC (scÃ©nario)</span> <span class="value" id="d_cumac">0</span></div>
  <div class="row"><span class="label">Prix CUMAC (â‚¬/MWh)</span> <span class="value" id="d_prix">0,00</span></div>
  <div class="row"><span class="label">CEE (â‚¬)</span> <span class="value" id="d_cee">0,00</span></div>
  <div class="small" style="font-size:12px;color:#64748b;margin-top:6px">CEE = (kWh cumac Ã· 1000) Ã— prix (â‚¬/MWh)</div>
</div>


<script>
(function(){
  window.CUMAC_RANGES = {
    "111_140": {
      H1:{ PAC:[238500,333900,477000,524700,763200], ELEC:[238500,333900,477000,524700,763200], THERMO:[254100,349500,492600,540300,778800], SSC:[769200,769200,769200,769200,769200] },
      H2:{ PAC:[198750,278250,397500,437250,636000], ELEC:[198750,278250,397500,437250,636000], THERMO:[214350,293850,413100,452850,651600], SSC:[769200,769200,769200,769200,769200] },
      H3:{ PAC:[139125,194775,278250,306075,445200], ELEC:[139125,194775,278250,306075,445200], THERMO:[154725,210375,293850,321675,460800], SSC:[769200,769200,769200,769200,769200] }
    },
    "140_170": {
      H1:{ PAC:[274800,384720,549600,604560,879360], ELEC:[274800,384720,549600,604560,879360], THERMO:[290400,400320,565200,620160,894960], SSC:[769200,769200,769200,769200,769200] },
      H2:{ PAC:[229000,320600,458000,503800,732800], ELEC:[229000,320600,458000,503800,732800], THERMO:[244600,336200,473600,519400,748400], SSC:[769200,769200,769200,769200,769200] },
      H3:{ PAC:[160300,224420,320600,352660,512960], ELEC:[160300,224420,320600,352660,512960], THERMO:[175900,240020,336200,368260,528560], SSC:[769200,769200,769200,769200,769200] }
    }
  };
  const $=id=>document.getElementById(id);
  const fr=n=> (typeof n==='number'&&isFinite(n))? n.toLocaleString('fr-FR'):'0';
  function etasRange(){
    const el=$('etas'); if(!el) return null;
    const raw=((el.options?.[el.selectedIndex]?.text||'')+' '+(el.value||'')).toString().replace(/\s/g,'').toUpperCase();
    if(/111/.test(raw)&&/140/.test(raw)) return "111_140";
    if(/140/.test(raw)&&/170/.test(raw)) return "140_170";
    return null;
  }
  function zoneKey(){const v=($('zone')?.value||'H1').toUpperCase(); if(v.includes('H3')) return 'H3'; if(v.includes('H2')) return 'H2'; return 'H1';}
  function surfIdx(){const s=$('surface'); let i=s?.selectedIndex ?? 4; if(i<0) i=0; if(i>4) i=4; return i;}
  function scenarioKeySingle(){
    const el=$('scenario'); const txt=(el?.options?.[el.selectedIndex]?.text||el?.value||'').toUpperCase();
    if(/ELECT|Ã‰LECT/.test(txt)) return 'ELEC';
    if(/THERMO/.test(txt)) return 'THERMO';
    if(/SSC/.test(txt)) return 'SSC';
    return 'PAC';
  }
  function currentCumacPrice(){
    const inp=$('prix_cumac');
    if(inp){ const v=parseFloat(String(inp.value).replace(',','.')); if(!isNaN(v)&&v>0) return v; }
    const f=($('foyer')?.value||'BLEU').toUpperCase();
    return (f==='BLEU')?11.78:7.00;
  }
  function computeCumacSingle(){
    const r=etasRange(); if(!r) return 0;
    const tbl=window.CUMAC_RANGES[r]?.[zoneKey()]; if(!tbl) return 0;
    const key=scenarioKeySingle(); return tbl[key]?.[surfIdx()]||0;
  }
  window.computeCumacSingle = computeCumacSingle;
  function updateCEE_withNewTables(){
    const cum=computeCumacSingle();
    const price=currentCumacPrice();
    const ceeInput=$('cee');
    if(ceeInput && cum>0) ceeInput.value = Math.round((cum/1000)*price);
    const card = $('cee_details');
    if(card){
      const zSel=$('zone'), sSel=$('surface'), eSel=$('etas'), scSel=$('scenario');
      const set=(id,val)=>{ const e=$(id); if(e) e.textContent = (typeof val==='number')? fr(val):val; };
      const r=etasRange();
      if(r){
        card.classList.remove('hidden');
        set('d_zone', zSel?.options?.[zSel.selectedIndex]?.text || zSel?.value || 'â€”');
        set('d_surface', sSel?.options?.[sSel.selectedIndex]?.text || 'â€”');
        set('d_etas', eSel?.options?.[eSel.selectedIndex]?.text || 'â€”');
        set('d_scenario', scSel?.options?.[scSel.selectedIndex]?.text || scSel?.value || 'â€”');
        set('d_cumac', cum);
        set('d_prix', currentCumacPrice().toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2}));
        set('d_cee', Math.round((cum/1000)*price));
      } else { card.classList.add('hidden'); }
    }
    // note under CEE tile
    try{
      var note=document.getElementById('cee_tile_cumac');
      var target=document.getElementById('cee_box')||document.querySelector('[data-cee-display]')||null;
      if(!note && target){
        note=document.createElement('div');
        note.id='cee_tile_cumac'; note.style.fontSize='12px'; note.style.color='#4b5563'; note.style.marginTop='4px';
        target.parentNode.appendChild(note);
      }
      if(note){ note.textContent = etasRange()? ('(kWh cumac : '+fr(cum)+')') : ''; }
    }catch(e){}
    if(typeof window.recalc==='function') window.recalc();
  }
  window.updateCEE_withNewTables = updateCEE_withNewTables;
  function boot(){
    ['etas','zone','surface','scenario','foyer','prix_cumac'].forEach(function(id){
      const el=$(id); if(el && !el.__cee_newtab){
        el.addEventListener('change', updateCEE_withNewTables);
        el.addEventListener('input', updateCEE_withNewTables);
        el.__cee_newtab = true;
      }
    });
    updateCEE_withNewTables();
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
  if(typeof window.recalc==='function' && !window.__cee_newtab_wrap){
    const __r=window.recalc; window.recalc=function(){ __r(); try{ updateCEE_withNewTables(); }catch(e){} };
    window.__cee_newtab_wrap=true;
  }
})();
</script>


<script>
(function(){
  const $=id=>document.getElementById(id);
  function defaultCumacPrice(){
    const f = ($('foyer')?.value || 'BLEU').toUpperCase();
    return f==='BLEU'? 11.78 : 7.00;
  }
  function applyDefaultCumacPriceIfEmpty(){
    const inp = $('prix_cumac');
    if(!inp) return;
    const val = parseFloat(String(inp.value).replace(',','.'));
    if(!(val>0)) inp.value = defaultCumacPrice().toFixed(2);
  }
  // On load and on foyer/scenario change, keep default if empty
  function bootCumacPrice(){
    applyDefaultCumacPriceIfEmpty();
    ['foyer','scenario'].forEach(id=>{
      const el=$(id);
      if(el && !el.__cumacprice){
        el.addEventListener('change', applyDefaultCumacPriceIfEmpty);
        el.__cumacprice=true;
      }
    });
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', bootCumacPrice); } else { bootCumacPrice(); }
})();
</script>

</body>
</html>
